<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Crop Image</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://rawgit.com/arccoder/selectincanvas.js/master/src/selectincanvas.js"></script>
</head>
<body>
<h1>Crop Image</h1>
<a id="dl" download="canvas.png" href="#">Download Cropped Canvas</a>
<br>
<canvas id="layer1" width="640" height="480" style="border:1px solid #000000; position:absolute; left:10; top:10;"></canvas>
<canvas id="layer2" width="640" height="480" style="border:1px solid #000000; position:absolute; left:10; top:10;"></canvas>

<script>

	// Canvas for image
	var canvas1 = document.getElementById("layer1");
	var ctx1 = canvas1.getContext("2d");
	// Canvas for overlay
	var canvas2 = document.getElementById("layer2");
    	var ctx2 = canvas2.getContext("2d");
	
	var img = new Image();
	img.crossOrigin = "Anonymous";
	img.onload = function(){
		ctx1.drawImage(img,canvas1.width/2-img.width/2,canvas1.height/2-img.height/2);
		
		// Invoke selectInCanvas.js
		sicJs = new SICjs("layer2",canvas2,ctx2,'#FF0000');
		sicJs.setLimits(canvas2.width/2-img.width/2,canvas2.height/2-img.height/2,img.width, img.height);
		sicJs.setRect(canvas2.width/2-img.width/2,canvas2.height/2-img.height/2,img.width, img.height);
	};
	img.src = "nature-nature.jpg";  
	
	document.getElementById("dl").addEventListener('click', dlCanvas, false);
	
	$("#layer2").dblclick(function(e){
		var cropRect = sicJs.getRect();
		var imgData = ctx1.getImageData(cropRect.x,cropRect.y,cropRect.w, cropRect.h);
		ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
		ctx1.putImageData(imgData,canvas1.width/2-imgData.width/2,canvas1.height/2-imgData.height/2);
		
		sicJs.setLimits(canvas2.width/2-imgData.width/2,canvas2.height/2-imgData.height/2,img.width, img.height);
	});
	
	/* REGISTER DOWNLOAD HANDLER */
	/* Only convert the canvas to Data URL when the user clicks. 
   	This saves RAM and CPU ressources in case this feature is not required. */
	function dlCanvas() {
		var cropRect = sicJs.getRect();
		var imgData = ctx1.getImageData(cropRect.x,cropRect.y,cropRect.w, cropRect.h);
		
		// Save roi image into another canvas to save locally
		var imgCanvas = document.createElement('canvas');
		imgCanvas.id = "saveimage";
		imgCanvas.width = cropRect.w;
		imgCanvas.height = cropRect.h;
		var imgCtx = imgCanvas.getContext("2d");
		imgCtx.putImageData(imgData,0,0);
		
  		var dt = imgCanvas.toDataURL('image/png');
  		/* Change MIME type to trick the browser to downlaod the file instead of displaying it */
  		dt = dt.replace(/^data:image\/[^;]*/, 'data:application/octet-stream');

  		/* In addition to <a>'s "download" attribute, you can define HTTP-style headers */
  		dt = dt.replace(/^data:application\/octet-stream/, 'data:application/octet-stream;headers=Content-Disposition%3A%20attachment%3B%20filename=Canvas.png');

  		this.href = dt;
	};
	
</script>

</body>
</html>
